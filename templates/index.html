<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ModelArk Video Generator</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <link rel="stylesheet" href="/static/css/custom.css">
</head>
<body class="bg-gray-50">
    {% raw %}
    <div id="app">
        <!-- Â∞éËà™Âàó -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center gap-3">
                        <h1 class="text-2xl font-bold text-gray-900">
                            üé¨ ModelArk Video Generator
                        </h1>
                        <span v-if="!apiKeyConfigured" class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">
                            ÈúÄË¶ÅÈÖçÁΩÆ
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button @click="refreshTasks" class="px-4 py-2 text-gray-600 hover:text-gray-900" title="Âà∑Êñ∞‰ªªÂãôÂàóË°®">
                            üîÑ
                        </button>
                        <button @click="showSettings = true" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                            ‚öôÔ∏è Ë®≠ÁΩÆ
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- ÂâµÂª∫‰ªªÂãôË°®ÂñÆ -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">ÂâµÂª∫Ë¶ñÈ†ªÁîüÊàê‰ªªÂãô</h2>
                <form @submit.prevent="createTask">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ÊèêÁ§∫Ë©û *
                            </label>
                            <textarea
                                v-model="newTask.prompt"
                                rows="4"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="ÊèèËø∞ÊÇ®ÊÉ≥Ë¶ÅÁîüÊàêÁöÑË¶ñÈ†ªÂÖßÂÆπ...&#10;‰æãÂ¶Ç: A detective enters a dimly lit room, dramatic lighting, cinematic shot"
                                required
                                :disabled="!apiKeyConfigured"
                            ></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ÂèÉËÄÉÂúñÁâáÔºàÂèØÈÅ∏Ôºâ
                            </label>

                            <!-- ÂàáÊèõÊåâÈàï -->
                            <div class="flex gap-2 mb-2">
                                <button
                                    type="button"
                                    @click="imageInputMode = 'url'"
                                    :class="imageInputMode === 'url' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    class="px-4 py-2 rounded-lg text-sm"
                                    :disabled="!apiKeyConfigured">
                                    ÂúñÁâá URL
                                </button>
                                <button
                                    type="button"
                                    @click="imageInputMode = 'upload'"
                                    :class="imageInputMode === 'upload' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    class="px-4 py-2 rounded-lg text-sm"
                                    :disabled="!apiKeyConfigured">
                                    ‰∏äÂÇ≥ÂúñÁâá
                                </button>
                            </div>

                            <!-- URL Ëº∏ÂÖ• -->
                            <div v-if="imageInputMode === 'url'">
                                <input
                                    type="url"
                                    v-model="newTask.image_url"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="https://example.com/image.jpg"
                                    :disabled="!apiKeyConfigured"
                                >
                            </div>

                            <!-- Êñá‰ª∂‰∏äÂÇ≥ -->
                            <div v-if="imageInputMode === 'upload'">
                                <input
                                    type="file"
                                    @change="handleImageUpload"
                                    accept="image/jpeg,image/png,image/webp,image/bmp,image/tiff,image/gif"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    :disabled="!apiKeyConfigured"
                                    ref="imageUpload"
                                >
                                <p v-if="uploadedImagePreview" class="mt-2">
                                    <img :src="uploadedImagePreview" class="max-w-xs max-h-40 rounded border" alt="Preview">
                                </p>
                            </div>

                            <p class="text-xs text-gray-500 mt-1">
                                Êèê‰æõÂúñÁâáÂèØ‰ª•ËÆì AI Ê†πÊìöÂúñÁâáÂÖßÂÆπÁîüÊàêË¶ñÈ†ªÔºàImage-to-VideoÔºâ<br>
                                ÊîØÊåÅÊ†ºÂºè: JPEG, PNG, WebP, BMP, TIFF, GIF | ÊúÄÂ§ß 30MB | Áü≠ÈÇä > 300px, Èï∑ÈÇä < 6000px
                            </p>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Èï∑ÂØ¨ÊØî (--rt)
                                </label>
                                <select v-model="newTask.ratio"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                        :disabled="!apiKeyConfigured">
                                    <option value="16:9">16:9 (Ê©´Âêë)</option>
                                    <option value="4:3">4:3</option>
                                    <option value="1:1">1:1 (ÊñπÂΩ¢)</option>
                                    <option value="3:4">3:4</option>
                                    <option value="9:16">9:16 (Áõ¥Âêë)</option>
                                    <option value="21:9">21:9 (Ë∂ÖÂØ¨)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ÊôÇÈï∑ (--dur) Áßí
                                </label>
                                <input
                                    type="number"
                                    v-model.number="newTask.duration"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                    min="2"
                                    max="12"
                                    :disabled="!apiKeyConfigured"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Ëß£ÊûêÂ∫¶ (--rs)
                                </label>
                                <select v-model="newTask.resolution"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                        :disabled="!apiKeyConfigured">
                                    <option value="480p">480p</option>
                                    <option value="720p">720p</option>
                                    <option value="1080p">1080p</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Á®ÆÂ≠ê (--seed)
                                </label>
                                <input
                                    type="number"
                                    v-model.number="newTask.seed"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                    placeholder="ÂèØÈÅ∏"
                                    :disabled="!apiKeyConfigured"
                                >
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <input
                                type="checkbox"
                                v-model="newTask.camera_fixed"
                                id="camera_fixed"
                                class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                                :disabled="!apiKeyConfigured"
                            >
                            <label for="camera_fixed" class="text-sm font-medium text-gray-700">
                                Âõ∫ÂÆöÈè°È†≠ (--cf)
                            </label>
                        </div>

                        <button
                            type="submit"
                            :disabled="!apiKeyConfigured || isCreating"
                            class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                            <span v-if="isCreating">‚è≥ ÂâµÂª∫‰∏≠...</span>
                            <span v-else>üöÄ ÈñãÂßãÁîüÊàê</span>
                        </button>

                        <p v-if="!apiKeyConfigured" class="text-sm text-yellow-600 text-center">
                            ‚ö†Ô∏è Ë´ãÂÖàÂú®Ë®≠ÁΩÆ‰∏≠ÈÖçÁΩÆ API Key
                        </p>
                    </div>
                </form>
            </div>

            <!-- ‰ªªÂãôÂàóË°® -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-xl font-semibold">‰ªªÂãôÂàóË°®</h2>
                    <span class="text-sm text-gray-500">ÂÖ± {{ tasks.length }} ÂÄã‰ªªÂãô</span>
                </div>

                <div v-if="tasks.length === 0" class="p-12 text-center text-gray-500">
                    <p class="text-lg">üì≠ Â∞öÁÑ°‰ªªÂãô</p>
                    <p class="text-sm mt-2">ÂâµÂª∫ÊÇ®ÁöÑÁ¨¨‰∏ÄÂÄãË¶ñÈ†ªÁîüÊàê‰ªªÂãôÂêßÔºÅ</p>
                </div>

                <div v-else class="divide-y">
                    <div v-for="task in tasks" :key="task.task_id"
                         class="p-6 hover:bg-gray-50 transition-colors">
                        <div class="flex justify-between items-start gap-4">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800 mb-2 line-clamp-2">{{ task.prompt }}</p>

                                <!-- ÈÄ≤Â∫¶Ê¢ù -->
                                <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                                    <div :class="getStatusColor(task.status)"
                                         :style="{width: task.progress + '%'}"
                                         class="h-2 rounded-full transition-all duration-300">
                                    </div>
                                </div>

                                <div class="flex items-center gap-4 text-sm flex-wrap">
                                    <span :class="getStatusBadge(task.status)"
                                          class="px-2 py-1 rounded-full font-medium">
                                        {{ getStatusText(task.status) }}
                                    </span>
                                    <span class="text-gray-500">
                                        üìÖ {{ formatDate(task.created_at) }}
                                    </span>
                                    <span class="text-gray-500">
                                        ‚è±Ô∏è {{ task.duration }}s ¬∑ {{ task.aspect_ratio }}
                                    </span>
                                    <span v-if="task.progress > 0 && task.progress < 100" class="text-blue-600">
                                        {{ task.progress.toFixed(0) }}%
                                    </span>
                                </div>

                                <p v-if="task.error_message" class="text-sm text-red-600 mt-2">
                                    ‚ùå {{ task.error_message }}
                                </p>
                            </div>

                            <div class="flex gap-2 flex-shrink-0">
                                <button v-if="task.status === 'completed'"
                                        @click="previewVideo(task.task_id)"
                                        class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors whitespace-nowrap">
                                    üëÅÔ∏è È†êË¶Ω
                                </button>
                                <button @click="deleteTask(task.task_id)"
                                        class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors whitespace-nowrap">
                                    üóëÔ∏è Âà™Èô§
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ë®≠ÁΩÆÊ®°ÊÖãÊ°Ü -->
        <div v-if="showSettings" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-semibold mb-4">API Ë®≠ÁΩÆ</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        BytePlus API Key
                    </label>
                    <input
                        type="password"
                        v-model="apiKey"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                        placeholder="Ëº∏ÂÖ•ÊÇ®ÁöÑ API Key">
                    <p class="text-xs text-gray-500 mt-2">
                        Ë®™Âïè <a href="https://console.byteplus.com/modelark" target="_blank" class="text-blue-600 hover:underline">BytePlus Console</a> Áç≤Âèñ API Key
                    </p>
                </div>
                <div class="flex gap-2">
                    <button @click="saveSettings"
                            :disabled="!apiKey.trim()"
                            class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                        ‰øùÂ≠ò
                    </button>
                    <button @click="showSettings = false"
                            class="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300">
                        ÂèñÊ∂à
                    </button>
                </div>
            </div>
        </div>

        <!-- Ë¶ñÈ†ªÈ†êË¶ΩÊ®°ÊÖãÊ°Ü -->
        <div v-if="previewTaskId" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Ë¶ñÈ†ªÈ†êË¶Ω</h3>
                    <button @click="previewTaskId = null" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">
                        ‚úï
                    </button>
                </div>
                <video controls autoplay class="w-full rounded-lg">
                    <source :src="`/api/video/${previewTaskId}`" type="video/mp4">
                    ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊåÅË¶ñÈ†ªÊí≠Êîæ„ÄÇ
                </video>
                <div class="mt-4 flex gap-2">
                    <a :href="`/api/video/${previewTaskId}`"
                       download
                       class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 text-center">
                        üíæ ‰∏ãËºâË¶ñÈ†ª
                    </a>
                    <button @click="previewTaskId = null"
                            class="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    <script src="/static/js/app.js"></script>
</body>
</html>
