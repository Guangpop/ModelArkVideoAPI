<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ModelArk Video Generator</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <link rel="stylesheet" href="/static/css/custom.css">
</head>
<body class="bg-gray-50">
    {% raw %}
    <div id="app">
        <!-- 導航列 -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center gap-3">
                        <h1 class="text-2xl font-bold text-gray-900">
                            🎬 ModelArk Video Generator
                        </h1>
                        <span v-if="!apiKeyConfigured" class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">
                            需要配置
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button @click="refreshTasks" class="px-4 py-2 text-gray-600 hover:text-gray-900" title="刷新任務列表">
                            🔄
                        </button>
                        <button @click="showSettings = true" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                            ⚙️ 設置
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 創建任務表單 -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">創建視頻生成任務</h2>
                <form @submit.prevent="createTask">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                提示詞 *
                            </label>
                            <textarea
                                v-model="newTask.prompt"
                                rows="4"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="描述您想要生成的視頻內容...&#10;例如: A detective enters a dimly lit room, dramatic lighting, cinematic shot"
                                required
                                :disabled="!apiKeyConfigured"
                            ></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                圖片使用模式（可選）
                            </label>
                            <select v-model="newTask.imageMode"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-3"
                                    :disabled="!apiKeyConfigured">
                                <option value="none">無圖片（純文本生成）</option>
                                <option value="first_frame">首幀（1 張圖片）</option>
                                <option value="first_last_frame">首尾幀（2 張圖片）</option>
                                <option value="reference">參考圖片（1-4 張圖片）</option>
                            </select>

                            <!-- 首幀模式 - 1張圖 -->
                            <div v-if="newTask.imageMode === 'first_frame'" class="space-y-3">
                                <div class="border border-gray-300 rounded-lg p-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">首幀圖片</label>
                                    <div class="flex gap-2 mb-2">
                                        <button type="button" @click="imageInputModes[0] = 'url'"
                                                :class="imageInputModes[0] === 'url' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                                class="px-3 py-1 rounded text-sm" :disabled="!apiKeyConfigured">URL</button>
                                        <button type="button" @click="imageInputModes[0] = 'upload'"
                                                :class="imageInputModes[0] === 'upload' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                                class="px-3 py-1 rounded text-sm" :disabled="!apiKeyConfigured">上傳</button>
                                    </div>
                                    <input v-if="imageInputModes[0] === 'url'" type="url" v-model="newTask.images[0]"
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                           placeholder="https://example.com/image.jpg" :disabled="!apiKeyConfigured">
                                    <div v-if="imageInputModes[0] === 'upload'">
                                        <input type="file" @change="(e) => handleImageUpload(e, 0)" ref="imageUpload0"
                                               accept="image/jpeg,image/png,image/webp,image/bmp,image/tiff,image/gif"
                                               class="w-full border border-gray-300 rounded px-2 py-1 text-sm" :disabled="!apiKeyConfigured">
                                        <img v-if="imagePreviews[0]" :src="imagePreviews[0]" class="mt-2 max-w-xs max-h-32 rounded border">
                                    </div>
                                </div>
                            </div>

                            <!-- 首尾幀模式 - 2張圖 -->
                            <div v-if="newTask.imageMode === 'first_last_frame'" class="space-y-3">
                                <!-- 首幀 -->
                                <div class="border border-gray-300 rounded-lg p-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">首幀圖片</label>
                                    <div class="flex gap-2 mb-2">
                                        <button type="button" @click="imageInputModes[0] = 'url'"
                                                :class="imageInputModes[0] === 'url' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                                class="px-3 py-1 rounded text-sm" :disabled="!apiKeyConfigured">URL</button>
                                        <button type="button" @click="imageInputModes[0] = 'upload'"
                                                :class="imageInputModes[0] === 'upload' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                                class="px-3 py-1 rounded text-sm" :disabled="!apiKeyConfigured">上傳</button>
                                    </div>
                                    <input v-if="imageInputModes[0] === 'url'" type="url" v-model="newTask.images[0]"
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                           placeholder="https://example.com/image.jpg" :disabled="!apiKeyConfigured">
                                    <div v-if="imageInputModes[0] === 'upload'">
                                        <input type="file" @change="(e) => handleImageUpload(e, 0)" ref="imageUpload0"
                                               accept="image/jpeg,image/png,image/webp,image/bmp,image/tiff,image/gif"
                                               class="w-full border border-gray-300 rounded px-2 py-1 text-sm" :disabled="!apiKeyConfigured">
                                        <img v-if="imagePreviews[0]" :src="imagePreviews[0]" class="mt-2 max-w-xs max-h-32 rounded border">
                                    </div>
                                </div>
                                <!-- 尾幀 -->
                                <div class="border border-gray-300 rounded-lg p-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">尾幀圖片</label>
                                    <div class="flex gap-2 mb-2">
                                        <button type="button" @click="imageInputModes[1] = 'url'"
                                                :class="imageInputModes[1] === 'url' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                                class="px-3 py-1 rounded text-sm" :disabled="!apiKeyConfigured">URL</button>
                                        <button type="button" @click="imageInputModes[1] = 'upload'"
                                                :class="imageInputModes[1] === 'upload' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                                class="px-3 py-1 rounded text-sm" :disabled="!apiKeyConfigured">上傳</button>
                                    </div>
                                    <input v-if="imageInputModes[1] === 'url'" type="url" v-model="newTask.images[1]"
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                           placeholder="https://example.com/image.jpg" :disabled="!apiKeyConfigured">
                                    <div v-if="imageInputModes[1] === 'upload'">
                                        <input type="file" @change="(e) => handleImageUpload(e, 1)" ref="imageUpload1"
                                               accept="image/jpeg,image/png,image/webp,image/bmp,image/tiff,image/gif"
                                               class="w-full border border-gray-300 rounded px-2 py-1 text-sm" :disabled="!apiKeyConfigured">
                                        <img v-if="imagePreviews[1]" :src="imagePreviews[1]" class="mt-2 max-w-xs max-h-32 rounded border">
                                    </div>
                                </div>
                            </div>

                            <!-- 參考圖片模式 - 1-4張圖 -->
                            <div v-if="newTask.imageMode === 'reference'" class="space-y-3">
                                <div v-for="(img, index) in newTask.referenceImages" :key="index" class="border border-gray-300 rounded-lg p-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-sm font-medium text-gray-700">參考圖片 {{ index + 1 }}</label>
                                        <button v-if="newTask.referenceImages.length > 1" type="button"
                                                @click="removeReferenceImage(index)"
                                                class="text-red-600 hover:text-red-800 text-sm" :disabled="!apiKeyConfigured">移除</button>
                                    </div>
                                    <div class="flex gap-2 mb-2">
                                        <button type="button" @click="refImageInputModes[index] = 'url'"
                                                :class="refImageInputModes[index] === 'url' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                                class="px-3 py-1 rounded text-sm" :disabled="!apiKeyConfigured">URL</button>
                                        <button type="button" @click="refImageInputModes[index] = 'upload'"
                                                :class="refImageInputModes[index] === 'upload' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                                class="px-3 py-1 rounded text-sm" :disabled="!apiKeyConfigured">上傳</button>
                                    </div>
                                    <input v-if="refImageInputModes[index] === 'url'" type="url" v-model="img.url"
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                           placeholder="https://example.com/image.jpg" :disabled="!apiKeyConfigured">
                                    <div v-if="refImageInputModes[index] === 'upload'">
                                        <input type="file" @change="(e) => handleRefImageUpload(e, index)" :ref="`refImageUpload${index}`"
                                               accept="image/jpeg,image/png,image/webp,image/bmp,image/tiff,image/gif"
                                               class="w-full border border-gray-300 rounded px-2 py-1 text-sm" :disabled="!apiKeyConfigured">
                                        <img v-if="refImagePreviews[index]" :src="refImagePreviews[index]" class="mt-2 max-w-xs max-h-32 rounded border">
                                    </div>
                                </div>
                                <button v-if="newTask.referenceImages.length < 4" type="button"
                                        @click="addReferenceImage"
                                        class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm"
                                        :disabled="!apiKeyConfigured">+ 添加參考圖片</button>
                                <p class="text-xs text-gray-500">
                                    💡 建議在提示詞中使用 [Image 1]、[Image 2] 等格式明確引用圖片
                                </p>
                            </div>

                            <p v-if="newTask.imageMode !== 'none'" class="text-xs text-gray-500 mt-2">
                                支持格式: JPEG, PNG, WebP, BMP, TIFF, GIF | 最大 30MB | 短邊 > 300px, 長邊 < 6000px
                            </p>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    長寬比 (--rt)
                                </label>
                                <select v-model="newTask.ratio"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                        :disabled="!apiKeyConfigured">
                                    <option value="16:9">16:9 (橫向)</option>
                                    <option value="4:3">4:3</option>
                                    <option value="1:1">1:1 (方形)</option>
                                    <option value="3:4">3:4</option>
                                    <option value="9:16">9:16 (直向)</option>
                                    <option value="21:9">21:9 (超寬)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    時長 (--dur) 秒
                                </label>
                                <input
                                    type="number"
                                    v-model.number="newTask.duration"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                    min="2"
                                    max="12"
                                    :disabled="!apiKeyConfigured"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    解析度 (--rs)
                                </label>
                                <select v-model="newTask.resolution"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                        :disabled="!apiKeyConfigured">
                                    <option value="480p">480p</option>
                                    <option value="720p">720p</option>
                                    <option value="1080p">1080p</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    種子 (--seed)
                                </label>
                                <input
                                    type="number"
                                    v-model.number="newTask.seed"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                    placeholder="可選"
                                    :disabled="!apiKeyConfigured"
                                >
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <input
                                type="checkbox"
                                v-model="newTask.camera_fixed"
                                id="camera_fixed"
                                class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                                :disabled="!apiKeyConfigured"
                            >
                            <label for="camera_fixed" class="text-sm font-medium text-gray-700">
                                固定鏡頭 (--cf)
                            </label>
                        </div>

                        <button
                            type="submit"
                            :disabled="!apiKeyConfigured || isCreating"
                            class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                            <span v-if="isCreating">⏳ 創建中...</span>
                            <span v-else>🚀 開始生成</span>
                        </button>

                        <p v-if="!apiKeyConfigured" class="text-sm text-yellow-600 text-center">
                            ⚠️ 請先在設置中配置 API Key
                        </p>
                    </div>
                </form>
            </div>

            <!-- 任務列表 -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-xl font-semibold">任務列表</h2>
                    <span class="text-sm text-gray-500">共 {{ tasks.length }} 個任務</span>
                </div>

                <div v-if="tasks.length === 0" class="p-12 text-center text-gray-500">
                    <p class="text-lg">📭 尚無任務</p>
                    <p class="text-sm mt-2">創建您的第一個視頻生成任務吧！</p>
                </div>

                <div v-else class="divide-y">
                    <div v-for="task in tasks" :key="task.task_id"
                         class="p-6 hover:bg-gray-50 transition-colors">
                        <div class="flex justify-between items-start gap-4">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800 mb-2 line-clamp-2">{{ task.prompt }}</p>

                                <!-- 進度條 -->
                                <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                                    <div :class="getStatusColor(task.status)"
                                         :style="{width: task.progress + '%'}"
                                         class="h-2 rounded-full transition-all duration-300">
                                    </div>
                                </div>

                                <div class="flex items-center gap-4 text-sm flex-wrap">
                                    <span :class="getStatusBadge(task.status)"
                                          class="px-2 py-1 rounded-full font-medium">
                                        {{ getStatusText(task.status) }}
                                    </span>
                                    <span class="text-gray-500">
                                        📅 {{ formatDate(task.created_at) }}
                                    </span>
                                    <span class="text-gray-500">
                                        ⏱️ {{ task.duration }}s · {{ task.aspect_ratio }}
                                    </span>
                                    <span v-if="task.progress > 0 && task.progress < 100" class="text-blue-600">
                                        {{ task.progress.toFixed(0) }}%
                                    </span>
                                </div>

                                <p v-if="task.error_message" class="text-sm text-red-600 mt-2">
                                    ❌ {{ task.error_message }}
                                </p>
                            </div>

                            <div class="flex gap-2 flex-shrink-0">
                                <button v-if="task.status === 'completed'"
                                        @click="previewVideo(task.task_id)"
                                        class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors whitespace-nowrap">
                                    👁️ 預覽
                                </button>
                                <button @click="deleteTask(task.task_id)"
                                        class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors whitespace-nowrap">
                                    🗑️ 刪除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 設置模態框 -->
        <div v-if="showSettings" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-semibold mb-4">API 設置</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        BytePlus API Key
                    </label>
                    <input
                        type="password"
                        v-model="apiKey"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                        placeholder="輸入您的 API Key">
                    <p class="text-xs text-gray-500 mt-2">
                        訪問 <a href="https://console.byteplus.com/modelark" target="_blank" class="text-blue-600 hover:underline">BytePlus Console</a> 獲取 API Key
                    </p>
                </div>
                <div class="flex gap-2">
                    <button @click="saveSettings"
                            :disabled="!apiKey.trim()"
                            class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                        保存
                    </button>
                    <button @click="showSettings = false"
                            class="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300">
                        取消
                    </button>
                </div>
            </div>
        </div>

        <!-- 視頻預覽模態框 -->
        <div v-if="previewTaskId" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">視頻預覽</h3>
                    <button @click="previewTaskId = null" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">
                        ✕
                    </button>
                </div>
                <video controls autoplay class="w-full rounded-lg">
                    <source :src="`/api/video/${previewTaskId}`" type="video/mp4">
                    您的瀏覽器不支持視頻播放。
                </video>
                <div class="mt-4 flex gap-2">
                    <a :href="`/api/video/${previewTaskId}`"
                       download
                       class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 text-center">
                        💾 下載視頻
                    </a>
                    <button @click="previewTaskId = null"
                            class="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300">
                        關閉
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    <script src="/static/js/app.js"></script>
</body>
</html>
